<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://unpkg.com/tabler-icons@1.39.1/iconfont/tabler-icons.min.css" rel="stylesheet"/>
  <style>
    :root {
      --orange: #ff6b00;
      --light-bg: #f8f9fa;
      --dark-text: #212529;
    }

    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', sans-serif;
      color: var(--dark-text);
    }

    .dashboard-container {
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .list-group-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 12px;
      padding: 15px 20px;
      transition: all 0.2s ease-in-out;
    }

    .list-group-item:hover {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.07);
    }

    .btn-available {
      background-color: #198754;
      color: white;
    }

    .btn-unavailable {
      background-color: #6c757d;
      color: white;
    }

    .btn-sm {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .modal-header {
      background-color: var(--orange);
      color: #fff;
    }

    .link {
      margin-top: 40px;
      text-align: center;
    }

    .link a {
      display: inline-block;
      background-color: var(--orange);
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.2s ease-in-out;
    }

    .link a:hover {
      background-color: #e65a00;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .top-bar h2 {
      font-weight: 700;
      font-size: 1.8rem;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="top-bar">
      <h2>üìä Dashboard Admin</h2>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn"><i class="ti ti-logout"></i> D√©connexion</button>
    </div>

    <div class="mb-5">
      <div class="section-title">üë• Utilisateurs</div>
      <div id="usersList"></div>
    </div>

    <div class="mb-5">
      <div class="section-title">üì¶ Commandes</div>
      <div id="ordersList"></div>
    </div>

    <div class="link">
      <a href="track.html" target="_blank">üîç Suivi de Commande</a>
    </div>
  </div>

  <!-- Modal d'√©dition -->
  <div class="modal fade" id="editModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚úçÔ∏è Modifier commande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="inputDepart" class="form-control mb-2" placeholder="D√©part" />
          <input type="text" id="inputArrivee" class="form-control mb-2" placeholder="Arriv√©e" />
          <textarea id="inputProduits" class="form-control mb-2" placeholder="Produits (s√©par√©s par des virgules)"></textarea>
          <input type="text" id="inputMontantColis" class="form-control mb-2" placeholder="Montant colis" />
          <input type="text" id="inputFrais" class="form-control mb-2" placeholder="Frais" />
          <input type="number" id="inputStatut" class="form-control mb-2" placeholder="Statut (0/1/2)" />
        </div>
        <div class="modal-footer">
          <button type="button" id="saveBtn" class="btn btn-success">‚úÖ Enregistrer</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = 'https://web-production-9c72c.up.railway.app';
    let editId = null;

    async function fetchUsers() {
      const res = await fetch(`${API}/api/users`);
      const users = await res.json();
      const container = document.getElementById('usersList');
      container.innerHTML = '';
      users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'list-group-item d-flex justify-content-between align-items-center';
        div.innerHTML = `
          <div>
            <strong>${u.username}</strong> (${u.role})<br/><small>${u.phone}</small>
          </div>
          ${u.role === 'livreur' ? 
            `<button class="btn btn-sm ${u.disponible ? 'btn-available' : 'btn-unavailable'}">
              ${u.disponible ? '‚úÖ Disponible' : '‚õîÔ∏è Indisponible'}
            </button>` : ''}
        `;
        if (u.role === 'livreur') {
          div.querySelector('button').onclick = () => toggleDispo(u.id, u.disponible);
        }
        container.appendChild(div);
      });
    }

    async function toggleDispo(userId, current) {
      const token = localStorage.getItem('token');
      await fetch(`${API}/api/livreur/${userId}/disponibilite`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ disponible: !current })
      });
      fetchUsers();
    }

    async function fetchCommands() {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API}/admin/commandes`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      const container = document.getElementById('ordersList');
      container.innerHTML = '';
      data.commandes.forEach(c => {
        const div = document.createElement('div');
        div.className = 'list-group-item';
        div.innerHTML = `
          <p><strong>${c.tracking_code}</strong> ‚Äë ${c.depart} ‚Üí ${c.arrivee}</p>
          <small>Total: ${c.montant_total} FCFA ‚Ä¢ Statut: ${c.statut}</small>
          <button class="btn btn-sm btn-primary mt-2">‚úèÔ∏è Modifier</button>
        `;
        div.querySelector('button').onclick = () => openModal(c);
        container.appendChild(div);
      });
    }

  function openModal(cmd) {
  editId = cmd.id;
  document.getElementById('inputDepart').value = cmd.depart;
  document.getElementById('inputArrivee').value = cmd.arrivee;
  document.getElementById('inputMontantColis').value = cmd.montant_colis || '';
  document.getElementById('inputFrais').value = cmd.frais || '';
  document.getElementById('inputStatut').value = cmd.statut;
  document.getElementById('inputProduits').value = (cmd.produits || []).join(', ');
  new bootstrap.Modal(document.getElementById('editModal')).show();
}


    document.getElementById('saveBtn').onclick = async () => {
      const token = localStorage.getItem('token');
      const body = {
        depart: document.getElementById('inputDepart').value,
        arrivee: document.getElementById('inputArrivee').value,
        montant_colis: parseFloat(document.getElementById('inputMontantColis').value),
        frais: parseFloat(document.getElementById('inputFrais').value),
        statut: parseInt(document.getElementById('inputStatut').value),
        produits: document.getElementById('inputProduits').value.split(',').map(p => p.trim()) // ‚á¶ important

      };
      await fetch(`${API}/admin/commandes/${editId}`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      fetchCommands();
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    };

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    };

    fetchUsers();
    fetchCommands();
  </script>
</body>
</html>
