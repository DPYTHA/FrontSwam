<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(120deg, #fff3f0, #ffe6e0);
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  h1 { color: orangered; text-align: center; margin-bottom: 30px; }
  h2 { margin-top: 30px; margin-bottom: 15px; color: #FF6B00; }
  .card {
    background: #f0f0f0;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
  }
  button {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    margin-top: 8px;
  }
  .btn-edit { background-color: #4CAF50; }
  .btn-dispo { margin-left: 10px; }
  .btn-refresh { background-color: #3498db; margin-bottom: 20px; }
  .btn-chat { background-color: #FF6B00; margin-bottom: 20px; display: inline-flex; align-items: center; padding: 10px 20px; border-radius: 25px; }
  .btn-logout { background-color: red; float: right; padding: 8px 12px; border-radius: 6px; color: white; font-weight: bold; }
  .modal {
    display: none;
    position: fixed; top: 0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
  }
  .modal-content h3 { text-align: center; color: orangered; margin-bottom: 20px; }
  .modal-content input {
    width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ccc;
  }
  .close-btn { background-color: gray; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
  <button class="btn-chat" onclick="alert('Ouvrir les chats')">üí¨ Mes Chats</button>
  <button class="btn-logout" onclick="logout()">D√©connexion</button>
  <button class="btn-refresh" onclick="fetchData()">üîÑ Rafra√Æchir</button>

  <h1>üìä Dashboard Admin</h1>

  <h2>üë• Utilisateurs</h2>
  <div id="users"></div>

  <h2>üì¶ Commandes</h2>
  <div id="commandes"></div>
</div>

<!-- Modal √©dition commande -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>‚úçÔ∏è Modifier la commande</h3>
    <input type="text" id="depart" placeholder="D√©part">
    <input type="text" id="arrivee" placeholder="Arriv√©e">
    <input type="text" id="tracking_code" placeholder="Code suivi">
    <input type="number" id="montant_colis" placeholder="Montant colis">
    <input type="number" id="frais" placeholder="Frais">
    <input type="number" id="statut" placeholder="Statut">
    <button id="saveBtn">‚úÖ Enregistrer</button>
    <button class="close-btn" onclick="closeModal()">‚ùå Annuler</button>
  </div>
</div>

<script>
  const BACKEND_URL = 'https://web-production-9c72c.up.railway.app';
  let currentCommande = null;

  async function fetchData() {
    const token = localStorage.getItem('access_token');

    // Utilisateurs
    try {
      const resUsers = await fetch(`${BACKEND_URL}/api/users`);
      const users = await resUsers.json();
      const usersDiv = document.getElementById('users');
      usersDiv.innerHTML = '';
      users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<strong>${user.username}</strong> - ${user.role}`;
        if(user.role==='livreur'){
          const btnDispo = document.createElement('button');
          btnDispo.className = 'btn-dispo';
          btnDispo.style.backgroundColor = user.disponible ? 'green':'grey';
          btnDispo.innerText = user.disponible ? '‚úÖ Disponible' : '‚õîÔ∏è Indisponible';
          btnDispo.onclick = () => toggleDispo(user.id, user.disponible);
          card.appendChild(btnDispo);
        }
        usersDiv.appendChild(card);
      });
    } catch(err){ console.error('Erreur utilisateurs:', err); }

    // Commandes
    try {
      const resCmd = await fetch(`${BACKEND_URL}/admin/commandes`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await resCmd.json();
      const commandes = data.commandes || [];
      const cmdDiv = document.getElementById('commandes');
      cmdDiv.innerHTML = '';
      commandes.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          Code: ${c.tracking_code} <br>
          De: ${c.depart} <br>
          √Ä: ${c.arrivee} <br>
          Montant colis: ${c.montant_colis} <br>
          Frais: ${c.frais} <br>
          Statut: ${c.statut} 
        `;
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn-edit';
        btnEdit.innerText = '‚úèÔ∏è Modifier';
        btnEdit.onclick = () => openModal(c);
        card.appendChild(btnEdit);
        cmdDiv.appendChild(card);
      });
    } catch(err){ console.error('Erreur commandes:', err); }
  }

  async function toggleDispo(userId, currentState) {
    try{
      await fetch(`${BACKEND_URL}/api/livreur/${userId}/disponibilite`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ disponible: !currentState })
      });
      fetchData();
    }catch(err){ console.error(err); }
  }

  function logout(){
    localStorage.removeItem('access_token');
    window.location.href = 'login.html';
  }

  function openModal(cmd){
    currentCommande = cmd;
    document.getElementById('depart').value = cmd.depart;
    document.getElementById('arrivee').value = cmd.arrivee;
    document.getElementById('tracking_code').value = cmd.tracking_code;
    document.getElementById('montant_colis').value = cmd.montant_colis;
    document.getElementById('frais').value = cmd.frais;
    document.getElementById('statut').value = cmd.statut;
    document.getElementById('modal').style.display = 'flex';
  }

  function closeModal(){
    currentCommande = null;
    document.getElementById('modal').style.display = 'none';
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    if(!currentCommande) return;
    const token = localStorage.getItem('access_token');
    const payload = {
      depart: document.getElementById('depart').value,
      arrivee: document.getElementById('arrivee').value,
      tracking_code: document.getElementById('tracking_code').value,
      montant_colis: parseFloat(document.getElementById('montant_colis').value),
      frais: parseFloat(document.getElementById('frais').value),
      statut: parseInt(document.getElementById('statut').value)
    };
    try{
      await fetch(`${BACKEND_URL}/admin/commandes/${currentCommande.id}`, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      closeModal();
      fetchData();
    }catch(err){ console.error('Erreur modification:', err); }
  });

  fetchData();
</script>
</body>
</html>
