<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Admin</title>
<style>
  /* Effet de clignotement rouge pour nouvelle commande */
  .new-order { animation: blink 1s infinite; }
  @keyframes blink {
    0%, 50%, 100% { background-color: #ff4d4d; }
    25%, 75% { background-color: #f0f0f0; }
  }

  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(120deg, #fff3f0, #ffe6e0); margin: 0; padding: 0; }
  .container { max-width: 900px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  h1 { color: orangered; text-align: center; margin-bottom: 30px; }
  h2 { margin-top: 30px; margin-bottom: 15px; color: #FF6B00; }
  .card { background: #f0f0f0; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
  button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #fff; margin-top: 8px; }
  .btn-edit { background-color: #4CAF50; }
  .btn-dispo { margin-left: 10px; }
  .btn-refresh { background-color: #3498db; margin-bottom: 20px; }
  .btn-chat { background-color: #FF6B00; margin-bottom: 20px; display: inline-flex; align-items: center; padding: 10px 20px; border-radius: 25px; }
  .btn-chat:hover{background-color: #ddae8d;}
  .btn-logout { background-color: red; float: right; padding: 8px 12px; border-radius: 6px; color: white; font-weight: bold; }
  .btn-track { background-color: #054874; margin-bottom: 20px; }
  .btn-track a{color: #f0f0f0;text-decoration: none;}
  .btn-track:hover{background-color: #3498db;}
  .btn-tofood{background-color: #a26f23; margin-bottom: 20px;}
  .btn-tofood:hover{background-color: #c38457;}
  .btn-tofood a{ text-decoration: none; color: #f0f0f0;}
  .btn-sound { background-color: #16a34a; margin-left: 10px; }
  .modal { display: none; position: fixed; top: 0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
  .modal-content h3 { text-align: center; color: orangered; margin-bottom: 20px; }
  .modal-content input, .modal-content textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ccc; }
  .close-btn { background-color: gray; margin-top: 10px; }
  .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
</style>
</head>
<body>
<div class="container">
  <div class="row">
    <button class="btn-chat" onclick="alert('Ouvrir les chats')">üí¨ Mes Chats</button>
    <button class="btn-refresh" onclick="fetchData()">üîÑ Rafra√Æchir</button>
    <button id="enableSound" class="btn-sound">üîî Activer le son</button>
    <button class="btn-logout" onclick="logout()">D√©connexion</button>
  </div>
  <div class="row">
    <button class="btn-tofood"><a href="campement.html">Commande Plats</a></button>
    <button class="btn-track"><a href="track.html">Voir la livraison</a></button>
  </div>

  <h1>üìä Dashboard Admin</h1>

  <h2>üë• Utilisateurs</h2>
  <div id="users"></div>

  <h2>üì¶ Commandes</h2>
  <div id="commandes"></div>
</div>

<audio id="alertSound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

<!-- Message d'alerte d√©filant -->
<marquee id="alertMarquee" behavior="scroll" direction="left" style="color: red; font-weight: bold; display:none;">
üö® Nouvelle commande d√©tect√©e !
</marquee>

<!-- Modal √©dition commande -->
<div class="modal" id="modal">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚úçÔ∏è Modifier la commande</h3>
    <input type="text" id="type" placeholder="Type de commande">
    <input type="text" id="depart" placeholder="D√©part">
    <input type="text" id="arrivee" placeholder="Arriv√©e">
    <textarea id="produits" placeholder="Produits (JSON ou texte)"></textarea>
    <input type="number" id="montant_colis" placeholder="Montant colis" step="0.01">
    <input type="number" id="frais" placeholder="Frais" step="0.01">
    <input type="number" id="montant_total" placeholder="Montant total" step="0.01">
    <input type="text" id="tracking_code" placeholder="Code suivi">
    <input type="number" id="statut" placeholder="Statut">
    <input type="number" id="user_id" placeholder="ID utilisateur">
    <button id="saveBtn">‚úÖ Enregistrer</button>
    <button class="close-btn" onclick="closeModal()">‚ùå Annuler</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const BACKEND_URL = 'https://web-production-9c72c.up.railway.app';

/* ---------- ETAT ---------- */
let currentCommande = null;
let seenIds = new Set();      // pour marquer les nouvelles commandes
let pollTimer = null;
let soundEnabled = false;

/* ---------- HELPERS ---------- */
function getToken() {
  return localStorage.getItem('access_token');
}
function authHeaders(json = true) {
  const headers = {};
  const token = getToken();
  if (json) headers['Content-Type'] = 'application/json';
  if (token) headers['Authorization'] = `Bearer ${token}`;
  return headers;
}


/* ---------- AUDIO / ALERTES ---------- */
const alertSound = document.getElementById('alertSound');
const alertMarquee = document.getElementById('alertMarquee');

document.getElementById('enableSound').addEventListener('click', async () => {
  try {
    // on essaye de jouer un petit son pour "d√©bloquer"
    await alertSound.play();
    soundEnabled = true;
    document.getElementById('enableSound').textContent = 'üîî Son activ√©';
  } catch (e) {
    console.warn('Le navigateur a bloqu√© l‚Äôaudio : ', e);
    alert('Clique encore une fois si le son ne se lance pas (politique navigateur).');
  }
});

function notifyNewOrders() {
  alertMarquee.style.display = 'block';
  if (soundEnabled) {
    alertSound.currentTime = 0;   // repartir au d√©but
    alertSound.play().catch(err => console.warn('Lecture bloqu√©e:', err));
  }
  // cacher le bandeau apr√®s 60s
  setTimeout(() => alertMarquee.style.display = 'none', 60000);
}

/* ---------- FETCH DATA ---------- */
async function fetchUsers() {
  try {
    // (ton /api/users n‚Äôest pas prot√©g√©, mais on met le header si jamais)
    const res = await fetch(`${BACKEND_URL}/api/users`, { headers: authHeaders(false) });
    const users = await res.json();
    const usersDiv = document.getElementById('users');
    usersDiv.innerHTML = '';
    users.forEach(user => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<strong>${user.username}</strong> - ${user.role}`;
      if (user.role === 'livreur') {
        const btnDispo = document.createElement('button');
        btnDispo.className = 'btn-dispo';
        btnDispo.style.backgroundColor = user.disponible ? 'green' : 'grey';
        btnDispo.innerText = user.disponible ? '‚úÖ Disponible' : '‚õîÔ∏è Indisponible';
        btnDispo.onclick = () => toggleDispo(user.id, user.disponible);
        card.appendChild(btnDispo);
      }
      usersDiv.appendChild(card);
    });
  } catch (err) {
    console.error('Erreur utilisateurs:', err);
  }
}

async function fetchCommandes() {
  try {
    const res = await fetch(`${BACKEND_URL}/admin/commandes`, { headers: authHeaders(false) });
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        console.warn('Acc√®s refus√©. Assure-toi que le token est pr√©sent et que l‚Äôutilisateur est admin.');
      }
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    const commandes = data.commandes || [];
    const cmdDiv = document.getElementById('commandes');
    cmdDiv.innerHTML = '';

    let hasNew = false;
    const currentIds = new Set();

    commandes.forEach(c => {
      currentIds.add(c.id);
      const isNew = !seenIds.has(c.id);
      if (isNew && seenIds.size > 0) {
        hasNew = true;
      }

      const card = document.createElement('div');
      card.className = 'card';
      if (isNew && seenIds.size > 0) {
        card.classList.add('new-order');
        // retire l‚Äôanimation apr√®s 60s pour ne pas clignoter √† l‚Äôinfini
        setTimeout(() => card.classList.remove('new-order'), 60000);
      }

      card.innerHTML = `
        <strong>Code:</strong> ${c.tracking_code} <br>
        <strong>Type:</strong> ${c.type} <br>
        <strong>De:</strong> ${c.depart} <br>
        <strong>√Ä:</strong> ${c.arrivee} <br>
        <strong>Produits:</strong> ${c.produits} <br>
        <strong>Montant colis:</strong> ${c.montant_colis} <br>
        <strong>Frais:</strong> ${c.frais} <br>
        <strong>Total:</strong> ${c.montant_total} <br>
        <strong>Statut:</strong> ${c.statut} <br>
        <strong>Utilisateur ID:</strong> ${c.user_id}
      `;

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-edit';
      btnEdit.innerText = '‚úèÔ∏è Modifier';
      btnEdit.addEventListener('click', () => openModal(c));
      card.appendChild(btnEdit);

      cmdDiv.appendChild(card);
    });

    // si des nouvelles commandes sont arriv√©es (apr√®s le 1er chargement)
    if (hasNew) notifyNewOrders();

    // mettre √† jour le set des commandes vues
    seenIds = currentIds;
  } catch (err) {
    console.error('Erreur commandes:', err);
  }
}

async function fetchData() {
  await Promise.all([fetchUsers(), fetchCommandes()]);
}

/* ---------- TOGGLE DISPONIBILIT√â LIVREUR ---------- */
async function toggleDispo(userId, currentState) {
  try {
    await fetch(`${BACKEND_URL}/api/livreur/${userId}/disponibilite`, {
      method: 'PUT',
      headers: authHeaders(),
      body: JSON.stringify({ disponible: !currentState })
    });
    fetchUsers();
  } catch (err) {
    console.error(err);
  }
}

/* ---------- MODAL EDIT ---------- */
function openModal(cmd) {
  currentCommande = cmd;
  document.getElementById('type').value = cmd.type ?? '';
  document.getElementById('depart').value = cmd.depart ?? '';
  document.getElementById('arrivee').value = cmd.arrivee ?? '';
  document.getElementById('produits').value = cmd.produits ?? '';
  document.getElementById('montant_colis').value = cmd.montant_colis ?? '';
  document.getElementById('frais').value = cmd.frais ?? '';
  document.getElementById('montant_total').value = cmd.montant_total ?? '';
  document.getElementById('tracking_code').value = cmd.tracking_code ?? '';
  document.getElementById('statut').value = cmd.statut ?? 0;
  document.getElementById('user_id').value = cmd.user_id ?? '';

  const modal = document.getElementById('modal');
  modal.style.display = 'flex';

  // fermer en cliquant sur le backdrop
  modal.onclick = () => closeModal();
}

function closeModal() {
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
  modal.onclick = null;
  currentCommande = null;
}

document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!currentCommande) return;

  const payload = {
    type: document.getElementById('type').value,
    depart: document.getElementById('depart').value,
    arrivee: document.getElementById('arrivee').value,
    produits: document.getElementById('produits').value,
    montant_colis: toNumber(document.getElementById('montant_colis').value),
    frais: toNumber(document.getElementById('frais').value),
    montant_total: toNumber(document.getElementById('montant_total').value),
    tracking_code: document.getElementById('tracking_code').value,
    statut: toInt(document.getElementById('statut').value),
    user_id: toInt(document.getElementById('user_id').value)
  };

  try {
    const res = await fetch(`${BACKEND_URL}/admin/commandes/${currentCommande.id}`, {
      method: 'PUT',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }
    closeModal();
    await fetchCommandes(); // rafra√Æchir la liste
  } catch (err) {
    console.error('Erreur modification:', err);
    alert("La modification a √©chou√©. V√©rifie que l'utilisateur connect√© est ADMIN et que le token est valide.");
  }
});

function toNumber(v) {
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v) {
  const n = parseInt(v, 10);
  return Number.isFinite(n) ? n : 0;
}

/* ---------- POLLING 20s (pause quand onglet cach√©) ---------- */
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(fetchData, 2000);
}
function stopPolling() {
  if (pollTimer) {
    clearInterval(pollTimer);
    pollTimer = null;
  }
}
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopPolling();
  else { fetchData(); startPolling(); }
});

/* ---------- AUTH ---------- */
function logout() {
  localStorage.removeItem('access_token');
  window.location.href = 'login.html';
}

/* ---------- INIT ---------- */
(async function init() {
  await fetchData();
  startPolling();
})();
</script>
</body>
</html>
