<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin</title>
<style>
  /* Effet de clignotement rouge */
  .new-order {
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%, 50%, 100% { background-color: #ff4d4d; }
    25%, 75% { background-color: #f0f0f0; }
  }
</style>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(120deg, #fff3f0, #ffe6e0); margin: 0; padding: 0; }
  .container { max-width: 900px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  h1 { color: orangered; text-align: center; margin-bottom: 30px; }
  h2 { margin-top: 30px; margin-bottom: 15px; color: #FF6B00; }
  .card { background: #f0f0f0; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
  button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #fff; margin-top: 8px; }
  .btn-edit { background-color: #4CAF50; }
  .btn-dispo { margin-left: 10px; }
  .btn-refresh { background-color: #3498db; margin-bottom: 20px; }
  .btn-chat { background-color: #FF6B00; margin-bottom: 20px; display: inline-flex; align-items: center; padding: 10px 20px; border-radius: 25px; }
  .btn-chat:hover{background-color: #ddae8d;}
  .btn-logout { background-color: red; float: right; padding: 8px 12px; border-radius: 6px; color: white; font-weight: bold; }
  .btn-track { background-color: #054874; margin-bottom: 20px; }
  .btn-track a{color: #f0f0f0;text-decoration: none;}
  .btn-track:hover{background-color: #3498db;}
  .btn-tofood{background-color: #a26f23; margin-bottom: 20px;}
  .btn-tofood:hover{background-color: #c38457;}
  .btn-tofood a{ text-decoration: none; color: #f0f0f0;}
  .modal { display: none; position: fixed; top: 0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
  .modal-content h3 { text-align: center; color: orangered; margin-bottom: 20px; }
  .modal-content input, .modal-content textarea {
    width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ccc;
  }
  .close-btn { background-color: gray; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
  <button class="btn-chat" onclick="alert('Ouvrir les chats')">üí¨ Mes Chats</button>
  <button class="btn-logout" onclick="logout()">D√©connexion</button>
  <button class="btn-refresh" onclick="fetchData()">üîÑ Rafra√Æchir</button>
  <button class="btn-tofood" ><a href="campement.html">Commande Plats</a></button>
  <button class="btn-track" ><a href="track.html">Voir la livraison</a></button>

  <h1>üìä Dashboard Admin</h1>

  <h2>üë• Utilisateurs</h2>
  <div id="users"></div>

  <h2>üì¶ Commandes</h2>
  <div id="commandes"></div>
</div>
<audio id="alertSound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

<!-- Message d'alerte d√©filant -->
<marquee id="alertMarquee" behavior="scroll" direction="left" style="color: red; font-weight: bold; display:none;">
üö® Nouvelle commande d√©tect√©e !
</marquee>
<!-- Modal √©dition commande -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>‚úçÔ∏è Modifier la commande</h3>
    <input type="text" id="type" placeholder="Type de commande">
    <input type="text" id="depart" placeholder="D√©part">
    <input type="text" id="arrivee" placeholder="Arriv√©e">
    <textarea id="produits" placeholder="Produits (JSON ou texte)"></textarea>
    <input type="number" id="montant_colis" placeholder="Montant colis">
    <input type="number" id="frais" placeholder="Frais">
    <input type="number" id="montant_total" placeholder="Montant total">
    <input type="text" id="tracking_code" placeholder="Code suivi">
    <input type="number" id="statut" placeholder="Statut">
    <input type="number" id="user_id" placeholder="ID utilisateur">
    <button id="saveBtn">‚úÖ Enregistrer</button>
    <button class="close-btn" onclick="closeModal()">‚ùå Annuler</button>
  </div>
</div>

<script>
const BACKEND_URL = 'https://web-production-9c72c.up.railway.app';
let currentCommande = null;
let lastCommandeDate = null; // Pour stocker la date de la derni√®re commande vue

async function fetchData() {
  const token = localStorage.getItem('access_token');

  // Utilisateurs (inchang√©)
  try {
    const resUsers = await fetch(`${BACKEND_URL}/api/users`, { headers: { Authorization: `Bearer ${token}` } });
    const users = await resUsers.json();
    const usersDiv = document.getElementById('users');
    usersDiv.innerHTML = '';
    users.forEach(user => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<strong>${user.username}</strong> - ${user.role}`;
      if(user.role==='livreur'){
        const btnDispo = document.createElement('button');
        btnDispo.className = 'btn-dispo';
        btnDispo.style.backgroundColor = user.disponible ? 'green':'grey';
        btnDispo.innerText = user.disponible ? '‚úÖ Disponible' : '‚õîÔ∏è Indisponible';
        btnDispo.onclick = () => toggleDispo(user.id, user.disponible);
        card.appendChild(btnDispo);
      }
      usersDiv.appendChild(card);
    });
  } catch(err){ console.error('Erreur utilisateurs:', err); }

  // Commandes avec d√©tection nouvelle commande
  try {
    const resCmd = await fetch(`${BACKEND_URL}/admin/commandes`, { headers: { Authorization: `Bearer ${token}` } });
    const data = await resCmd.json();
    const commandes = data.commandes || [];
    const cmdDiv = document.getElementById('commandes');
    cmdDiv.innerHTML = '';

    commandes.forEach((c, index) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <strong>Code:</strong> ${c.tracking_code} <br>
        <strong>Type:</strong> ${c.type} <br>
        <strong>De:</strong> ${c.depart} <br>
        <strong>√Ä:</strong> ${c.arrivee} <br>
        <strong>Produits:</strong> ${c.produits} <br>
        <strong>Montant colis:</strong> ${c.montant_colis} <br>
        <strong>Frais:</strong> ${c.frais} <br>
        <strong>Total:</strong> ${c.montant_total} <br>
        <strong>Statut:</strong> ${c.statut} <br>
        <strong>Utilisateur ID:</strong> ${c.user_id}
      `;

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-edit';
      btnEdit.innerText = '‚úèÔ∏è Modifier';
      btnEdit.onclick = () => openModal(c);
      card.appendChild(btnEdit);

      // V√©rifier si c'est une nouvelle commande
      const cmdDate = new Date(c.date_commande);
      if (!lastCommandeDate || cmdDate > new Date(lastCommandeDate)) {
        if (index === 0 && lastCommandeDate) { // Seulement si c'est plus r√©cent que la derni√®re vue
          card.classList.add("new-order");
          document.getElementById("alertMarquee").style.display = "block";
          document.getElementById("alertSound").play();
        }
      }

      cmdDiv.appendChild(card);
    });

    // Mettre √† jour la derni√®re commande vue
    if (commandes.length > 0) {
      lastCommandeDate = commandes[0].date_commande;
    }
  } catch(err){ console.error('Erreur commandes:', err); }
}

// Rafra√Æchir toutes les 20 secondes
setInterval(fetchData, 20000);

fetchData();
</script>
</body>
</html>
