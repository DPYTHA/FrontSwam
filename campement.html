<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Campement</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(120deg, #fff7f0, #ffe6e0);
    margin: 0; padding: 0;
  }
  .container {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  h1 { color: orangered; text-align: center; margin-bottom: 30px; }
  .card {
    background: #f0f0f0;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
  }
  button {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    margin-top: 8px;
  }
  .btn-edit { background-color: #4CAF50; }
  .btn-refresh { background-color: #3498db; margin-bottom: 20px; }
  .btn-logout { background-color: red; float: right; padding: 8px 12px; border-radius: 6px; color: white; font-weight: bold; }
  .modal {
    display: none;
    position: fixed; top: 0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
  }
  .modal-content h3 { text-align: center; color: orangered; margin-bottom: 20px; }
  .modal-content input, .modal-content textarea {
    width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ccc;
  }
  .close-btn { background-color: gray; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
  <button class="btn-refresh" onclick="fetchCommandes()">üîÑ Rafra√Æchir</button>
  <button class="btn-logout" onclick="logout()">D√©connexion</button>

  <h1>üçΩÔ∏è Commandes Resto</h1>
  <div id="commandes"></div>
</div>

<!-- Modal √©dition commande -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>‚úçÔ∏è Modifier la commande</h3>
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <input type="text" id="phone" placeholder="T√©l√©phone">
    <textarea id="panier" placeholder='Panier (JSON)'></textarea>
    <textarea id="adresse_livraison" placeholder="Adresse livraison"></textarea>
    <input type="number" id="frais_livraison" placeholder="Frais livraison" step="0.01">
    <input type="number" id="montant_total" placeholder="Montant total" step="0.01">
    <input type="datetime-local" id="date_commande" placeholder="Date commande">
    <button id="saveBtn">‚úÖ Enregistrer</button>
    <button class="close-btn" onclick="closeModal()">‚ùå Annuler</button>
  </div>
</div>

<script>
  const BACKEND_URL = 'https://web-production-9c72c.up.railway.app';
  let currentCommande = null;

  async function fetchCommandes() {
    const token = localStorage.getItem('access_token');
    try {
      const res = await fetch(`${BACKEND_URL}/commandesResto`, { 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      const commandes = await res.json();
      const cmdDiv = document.getElementById('commandes');
      cmdDiv.innerHTML = '';
      commandes.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          ${c.nom} ${c.prenom} <br>
          üìû ${c.phone} <br>
          üõí ${JSON.stringify(c.panier)} <br>
          üìç ${c.adresse_livraison} <br>
          Frais: ${c.frais_livraison} - Total: ${c.montant_total} <br>
          Date: ${new Date(c.date_commande).toLocaleString()}
        `;
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn-edit';
        btnEdit.innerText = '‚úèÔ∏è Modifier';
        btnEdit.onclick = () => openModal(c);
        card.appendChild(btnEdit);
        cmdDiv.appendChild(card);
      });
    } catch(err){ console.error('Erreur commandes resto:', err); }
  }

  function logout() {
    localStorage.removeItem('access_token');
    window.location.href = 'login.html';
  }

  function openModal(cmd){
    currentCommande = cmd;
    document.getElementById('nom').value = cmd.nom;
    document.getElementById('prenom').value = cmd.prenom;
    document.getElementById('phone').value = cmd.phone;
    document.getElementById('panier').value = JSON.stringify(cmd.panier);
    document.getElementById('adresse_livraison').value = cmd.adresse_livraison;
    document.getElementById('frais_livraison').value = cmd.frais_livraison;
    document.getElementById('montant_total').value = cmd.montant_total;
    document.getElementById('date_commande').value = new Date(cmd.date_commande).toISOString().slice(0,16);
    document.getElementById('modal').style.display = 'flex';
  }

  function closeModal(){
    currentCommande = null;
    document.getElementById('modal').style.display = 'none';
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    if(!currentCommande) return;
    const token = localStorage.getItem('access_token');
    const payload = {
      nom: document.getElementById('nom').value,
      prenom: document.getElementById('prenom').value,
      phone: document.getElementById('phone').value,
      panier: JSON.parse(document.getElementById('panier').value),
      adresse_livraison: document.getElementById('adresse_livraison').value,
      frais_livraison: parseFloat(document.getElementById('frais_livraison').value),
      montant_total: parseFloat(document.getElementById('montant_total').value),
      date_commande: new Date(document.getElementById('date_commande').value).toISOString()
    };
    try{
      await fetch(`${BACKEND_URL}/resto/commandes/${currentCommande.id}`, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      closeModal();
      fetchCommandes();
    }catch(err){ console.error('Erreur modification commande:', err); }
  });

  fetchCommandes();
</script>
</body>
</html>
