<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Commandes - Campement</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #333; color: white; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .edit-form { display: none; background: #fff; padding: 15px; border-radius: 5px; margin-top: 20px; }
    .form-group { margin-bottom: 10px; }
    label { display: block; font-weight: bold; }
    input, textarea { width: 100%; padding: 8px; }
    .btn-save { background: green; color: white; border: none; }
    .btn-cancel { background: gray; color: white; border: none; }
    /* Nouveau style pour alerte commande */
    #alertMarquee { display: none; color: red; font-weight: bold; margin-top: 10px; }
    .new-order { background-color: #ffdddd; animation: blink 1s infinite; }
    @keyframes blink { 0%, 50%, 100% { background-color: #ffdddd; } 25%, 75% { background-color: #fff; } }
    #soundBtn { margin-bottom: 10px; padding: 8px 12px; background: #16a34a; color: white; border: none; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<h1>üì¶ Commandes Clients</h1>

<button id="soundBtn">üîî Activer le son</button>
<marquee id="alertMarquee" behavior="scroll" direction="left">
üö® Nouvelle commande d√©tect√©e !
</marquee>

<table id="commandesTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>T√©l√©phone</th>
            <th>Panier</th>
            <th>Adresse</th>
            <th>Frais Livraison</th>
            <th>Total</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="edit-form" id="editForm">
    <h2>Modifier la commande</h2>
    <form id="updateForm">
        <input type="hidden" id="editId">
        <div class="form-group">
            <label>Nom :</label>
            <input type="text" id="editNom">
        </div>
        <div class="form-group">
            <label>Pr√©nom :</label>
            <input type="text" id="editPrenom">
        </div>
        <div class="form-group">
            <label>T√©l√©phone :</label>
            <input type="text" id="editPhone">
        </div>
        <div class="form-group">
            <label>Panier (JSON) :</label>
            <textarea id="editPanier"></textarea>
        </div>
        <div class="form-group">
            <label>Adresse Livraison :</label>
            <input type="text" id="editAdresse">
        </div>
        <div class="form-group">
            <label>Frais Livraison :</label>
            <input type="number" id="editFrais">
        </div>
        <div class="form-group">
            <label>Montant Total :</label>
            <input type="number" id="editTotal">
        </div>
        <div class="form-group">
            <label>Date Commande :</label>
            <input type="datetime-local" id="editDate">
        </div>
        <button type="submit" class="btn-save">üíæ Sauvegarder</button>
        <button type="button" class="btn-cancel" onclick="cancelEdit()">‚ùå Annuler</button>
    </form>
</div>

<script>
const API_URL = "https://web-production-9c72c.up.railway.app/commandesResto";
let seenIds = new Set();
let soundEnabled = false;

document.getElementById('soundBtn').addEventListener('click', () => {
    soundEnabled = true;
    document.getElementById('soundBtn').textContent = "üîî Son activ√©";
});

// Fonction bip sonore
function playBeep() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(frequency, duration, delay) {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = "sine";
        oscillator.frequency.value = frequency;
        oscillator.start(audioCtx.currentTime + delay);
        oscillator.stop(audioCtx.currentTime + delay + duration / 1000);
        gainNode.gain.setValueAtTime(1, audioCtx.currentTime + delay);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration / 1000);
    }
    beep(440, 200, 0);
    beep(440, 200, 0.4);
}

// Fonction de notification nouvelle commande
function notifyNewOrders() {
    const alertMarquee = document.getElementById('alertMarquee');
    alertMarquee.style.display = 'block';
    if (soundEnabled) playBeep();
    setTimeout(() => alertMarquee.style.display = 'none', 60000);
}

async function fetchCommandes() {
    const res = await fetch(API_URL);
    const data = await res.json();
    const tbody = document.querySelector("#commandesTable tbody");
    tbody.innerHTML = "";
    let hasNew = false;
    const currentIds = new Set();

    data.forEach(cmd => {
        currentIds.add(cmd.id);
        const isNew = !seenIds.has(cmd.id);
        if (isNew && seenIds.size > 0) hasNew = true;

        const tr = document.createElement("tr");
        if (isNew && seenIds.size > 0) tr.classList.add("new-order");

        tr.innerHTML = `
            <td>${cmd.id}</td>
            <td>${cmd.nom}</td>
            <td>${cmd.prenom}</td>
            <td>${cmd.phone}</td>
            <td><pre>${JSON.stringify(cmd.panier, null, 2)}</pre></td>
            <td>${cmd.adresse_livraison}</td>
            <td>${cmd.frais_livraison}</td>
            <td>${cmd.montant_total}</td>
            <td>${cmd.date_commande}</td>
            <td><button onclick='editCommande(${JSON.stringify(cmd)})'>‚úè Modifier</button></td>
        `;
        tbody.appendChild(tr);
    });

    if (hasNew) notifyNewOrders();
    seenIds = currentIds;
}

function editCommande(cmd) {
    document.getElementById("editForm").style.display = "block";
    document.getElementById("editId").value = cmd.id;
    document.getElementById("editNom").value = cmd.nom;
    document.getElementById("editPrenom").value = cmd.prenom;
    document.getElementById("editPhone").value = cmd.phone;
    document.getElementById("editPanier").value = JSON.stringify(cmd.panier, null, 2);
    document.getElementById("editAdresse").value = cmd.adresse_livraison;
    document.getElementById("editFrais").value = cmd.frais_livraison;
    document.getElementById("editTotal").value = cmd.montant_total;
    document.getElementById("editDate").value = cmd.date_commande.replace("Z", "");
}

function cancelEdit() { document.getElementById("editForm").style.display = "none"; }

document.getElementById("updateForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    const payload = {
        id: parseInt(id),
        nom: document.getElementById("editNom").value,
        prenom: document.getElementById("editPrenom").value,
        phone: document.getElementById("editPhone").value,
        panier: JSON.parse(document.getElementById("editPanier").value),
        adresse_livraison: document.getElementById("editAdresse").value,
        frais_livraison: parseFloat(document.getElementById("editFrais").value),
        montant_total: parseFloat(document.getElementById("editTotal").value),
        date_commande: new Date(document.getElementById("editDate").value).toISOString()
    };
    
    const res = await fetch(API_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
    
    if (res.ok) {
        alert("Commande mise √† jour !");
        cancelEdit();
        fetchCommandes();
    } else {
        alert("Erreur lors de la mise √† jour");
    }
});

// Initialisation & polling
fetchCommandes();
setInterval(fetchCommandes, 5000); // v√©rifier toutes les 5 secondes
</script>

</body>
</html>
